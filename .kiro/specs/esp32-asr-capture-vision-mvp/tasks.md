# 實作計畫：ESP32 ASR 捕捉視覺 MVP

## 概述

本實作計畫將 ESP32 ASR 捕捉視覺系統分解為可執行的編碼任務。系統使用 Python（後端）、HTML/JavaScript（前端）及 C++/Arduino（ESP32 韌體）實作。任務按照依賴順序排列，每個任務都建立在前一個任務的基礎上。

## 任務

- [x] 1. 建立專案結構及核心介面
  - 建立目錄結構（backend/、web/、device/、docs/、tests/）
  - 設定 Python 虛擬環境及依賴（FastAPI、websockets、asyncio）
  - 定義核心資料模型（Event、RequestContext、ConnectionState）
  - 設定測試框架（pytest、pytest-asyncio、Hypothesis）
  - _需求：所有需求的基礎設施_

- [ ] 2. 實作事件匯流排
  - [x] 2.1 實作 EventBus 類別
    - 實作發布/訂閱機制（使用 asyncio.Queue）
    - 實作環形緩衝區（保留最近 100 筆事件）
    - 實作歷史查詢方法
    - _需求：8.1, 8.2, 8.3_
  
  - [ ]* 2.2 撰寫 EventBus 屬性測試
    - **屬性 11：事件記錄完整性**
    - **驗證：需求 8.1, 8.4**
  
  - [ ]* 2.3 撰寫環形緩衝區屬性測試
    - **屬性 12：環形緩衝區行為**
    - **驗證：需求 8.2**
  
  - [ ]* 2.4 撰寫歷史查詢屬性測試
    - **屬性 9：歷史事件查詢**
    - **驗證：需求 5.6, 8.3**

- [ ] 3. 實作 WebSocket 閘道
  - [x] 3.1 建立 FastAPI 應用程式及 WebSocket 端點
    - 實作 `/ws_audio`、`/ws_ctrl`、`/ws_camera`、`/ws_ui` 端點
    - 實作連線管理（ConnectionState 追蹤）
    - 實作心跳機制（30 秒 ping，60 秒超時）
    - _需求：1.1, 5.1_
  
  - [x] 3.2 實作訊息路由邏輯
    - 根據連線類型路由訊息至對應處理器
    - 實作二進位及 JSON 訊息處理
    - _需求：1.1, 3.1_
  
  - [ ]* 3.3 撰寫 WebSocket 連線單元測試
    - 測試連線建立與關閉
    - 測試心跳機制
    - 測試訊息路由
    - _需求：1.1, 5.1_

- [x] 4. 檢查點 - 確保基礎設施測試通過
  - 確保所有測試通過，如有問題請詢問使用者。

- [ ] 5. 實作 ASR 橋接器
  - [x] 5.1 實作 ASRBridge 類別
    - 實作與 Qwen3-ASR-Flash-Realtime 的 WebSocket 連線
    - 實作音訊串流轉發
    - 實作轉錄結果接收（partial 及 final）
    - 實作斷線重連機制（5 秒重試，最多 3 次）
    - _需求：1.2, 1.3, 1.5, 6.2_
  
  - [x] 5.2 實作音訊格式驗證
    - 驗證 PCM16 單聲道 16kHz 格式
    - 拒絕無效格式並記錄錯誤
    - _需求：1.4_
  
  - [ ]* 5.3 撰寫音訊處理屬性測試
    - **屬性 1：音訊串流端到端處理**
    - **驗證：需求 1.1, 1.2, 1.3**
  
  - [ ]* 5.4 撰寫音訊格式驗證屬性測試
    - **屬性 2：音訊格式驗證**
    - **驗證：需求 1.4**
  
  - [ ]* 5.5 撰寫 ASR 重連單元測試
    - 測試斷線檢測
    - 測試重連邏輯（5 秒間隔，3 次重試）
    - 測試認證失敗處理
    - _需求：1.5, 6.2_

- [ ] 6. 實作觸發引擎
  - [x] 6.1 實作 TriggerEngine 類別
    - 實作關鍵詞匹配邏輯（「識別物品」、「認下呢個係咩」等）
    - 實作 req_id 生成（使用 UUID）
    - 實作冷卻機制（3 秒）
    - 實作並發控制（限制 1 個活躍請求）
    - _需求：2.1, 2.2, 2.3, 2.4_
  
  - [ ]* 6.2 撰寫觸發檢測屬性測試
    - **屬性 3：觸發詞檢測與事件生成**
    - **驗證：需求 2.1, 2.2, 2.5**
  
  - [ ]* 6.3 撰寫並發控制屬性測試
    - **屬性 4：並發觸發控制**
    - **驗證：需求 2.3**
  
  - [ ]* 6.4 撰寫 req_id 唯一性屬性測試
    - **屬性 14：req_id 唯一性**
    - **驗證：需求 2.2**
  
  - [ ]* 6.5 撰寫冷卻機制單元測試
    - 測試 3 秒冷卻期
    - 測試冷卻期間拒絕觸發
    - _需求：2.4_

- [ ] 7. 實作拍照協調器
  - [x] 7.1 實作 CaptureCoordinator 類別
    - 實作 CAPTURE 指令發送至 ESP32
    - 實作影像接收及 req_id 驗證
    - 實作超時處理（5 秒）
    - 實作狀態機（IDLE → CAPTURE_REQUESTED → WAITING_IMAGE → IMAGE_RECEIVED/ERROR）
    - _需求：3.1, 3.3, 3.4_
  
  - [x] 7.2 實作影像大小驗證
    - 驗證解析度不超過 640x480
    - 驗證檔案大小不超過 200KB
    - 拒絕無效影像並記錄錯誤
    - _需求：3.5_
  
  - [ ]* 7.3 撰寫拍照協調屬性測試
    - **屬性 5：拍照指令與影像接收協調**
    - **驗證：需求 3.1, 3.3**
  
  - [ ]* 7.4 撰寫影像大小限制屬性測試
    - **屬性 6：影像大小限制**
    - **驗證：需求 3.5**
  
  - [ ]* 7.5 撰寫超時處理單元測試
    - 測試 5 秒超時
    - 測試超時後狀態恢復
    - _需求：3.4_

- [x] 8. 檢查點 - 確保核心邏輯測試通過
  - 確保所有測試通過，如有問題請詢問使用者。

- [ ] 9. 實作視覺模型適配器
  - [x] 9.1 實作 VisionLLMAdapter 基礎類別
    - 定義抽象介面（analyze_image 方法）
    - 定義 VisionResult 資料類別
    - _需求：4.1, 4.4_
  
  - [x] 9.2 實作 QwenOmniAdapter
    - 實作 Qwen Omni Flash API 呼叫
    - 實作影像 base64 編碼
    - 實作提示詞組合
    - 實作超時處理（15 秒）
    - 實作錯誤處理及重試（1 次，5 秒間隔）
    - _需求：4.1, 4.2, 4.3_
  
  - [ ]* 9.3 撰寫視覺模型屬性測試
    - **屬性 7：視覺模型呼叫與結果處理**
    - **驗證：需求 4.1, 4.2, 4.5**
  
  - [ ]* 9.4 撰寫視覺模型錯誤處理單元測試
    - 測試 API 錯誤處理
    - 測試 15 秒超時
    - 測試重試機制
    - _需求：4.3_

- [ ] 10. 整合所有組件
  - [x] 10.1 實作主應用程式邏輯
    - 連接 EventBus、ASRBridge、TriggerEngine、CaptureCoordinator、VisionLLMAdapter
    - 實作完整的事件流程（音訊 → ASR → 觸發 → 拍照 → 視覺 → UI）
    - 實作錯誤事件廣播
    - _需求：所有需求_
  
  - [x] 10.2 實作 HTTP API 端點
    - 實作 `GET /api/history`（歷史事件查詢）
    - 實作 `GET /api/health`（健康檢查）
    - 實作 `POST /api/ask`（手動觸發，可選）
    - _需求：5.6, 8.3_
  
  - [ ]* 10.3 撰寫 UI 事件推送屬性測試
    - **屬性 8：UI 事件推送完整性**
    - **驗證：需求 5.1, 5.3**
  
  - [ ]* 10.4 撰寫重連狀態恢復屬性測試
    - **屬性 10：重連後狀態恢復**
    - **驗證：需求 6.4**

- [ ] 11. 實作配置管理及安全性
  - [x] 11.1 實作環境變數載入
    - 從環境變數讀取 API 金鑰
    - 實作配置驗證（啟動時檢查必要金鑰）
    - 實作啟動失敗處理
    - _需求：7.1, 7.4, 7.5_
  
  - [ ]* 11.2 撰寫安全性單元測試
    - 測試 API 金鑰不出現在前端程式碼
    - 測試配置驗證
    - 測試缺失金鑰時拒絕啟動
    - _需求：7.1, 7.2, 7.4, 7.5_

- [ ] 12. 實作錯誤處理及日誌
  - [x] 12.1 實作統一錯誤處理
    - 定義 ErrorType 枚舉
    - 實作錯誤事件生成
    - 實作錯誤恢復策略（根據錯誤類型）
    - _需求：所有需求的錯誤處理_
  
  - [ ]* 12.2 撰寫錯誤記錄屬性測試
    - **屬性 13：錯誤記錄完整性**
    - **驗證：需求 8.5**
  
  - [ ]* 12.3 撰寫錯誤恢復單元測試
    - 測試各種錯誤類型的恢復策略
    - 測試重試機制
    - 測試退避演算法
    - _需求：所有需求的錯誤處理_

- [x] 13. 檢查點 - 確保後端整合測試通過
  - 確保所有測試通過，如有問題請詢問使用者。

- [ ] 14. 實作網頁 UI
  - [x] 14.1 建立基礎 HTML/CSS 結構
    - 建立單頁應用程式佈局
    - 實作 ASR 文字顯示區域
    - 實作觸發事件列表
    - 實作影像顯示區域
    - 實作視覺辨識結果顯示區域
    - _需求：5.2, 5.3, 5.4, 5.5_
  
  - [x] 14.2 實作 WebSocket 客戶端
    - 連接至 `/ws_ui` 端點
    - 實作事件接收及處理
    - 實作斷線檢測及重連（1 秒起始，指數退避）
    - 實作連線狀態顯示
    - _需求：5.1, 6.3_
  
  - [x] 14.3 實作歷史事件載入
    - 呼叫 `GET /api/history` API
    - 顯示最近 20 筆事件
    - 實作事件列表渲染
    - _需求：5.6_
  
  - [ ]* 14.4 撰寫 UI 整合測試
    - 測試 WebSocket 連線
    - 測試事件顯示
    - 測試歷史載入
    - _需求：5.1, 5.2, 5.3, 5.4, 5.5, 5.6_

- [ ] 15. 實作 ESP32 模擬器（Python）
  - [x] 15.1 建立 ESP32 模擬器腳本
    - 實作音訊檔案讀取（PCM16）
    - 實作 WebSocket 連線至 `/ws_audio`
    - 實作音訊串流發送（100ms/chunk）
    - _需求：1.1_
  
  - [x] 15.2 實作拍照模擬
    - 連接至 `/ws_ctrl` 接收 CAPTURE 指令
    - 連接至 `/ws_camera` 上傳 JPEG
    - 實作 req_id 關聯
    - _需求：3.1, 3.2, 3.3_
  
  - [x] 15.3 實作斷線重連模擬
    - 實作斷線檢測
    - 實作 3 秒重連邏輯
    - 實作指數退避
    - _需求：6.1_
  
  - [ ]* 15.4 撰寫模擬器使用文件
    - 說明如何使用模擬器
    - 提供範例指令
    - 提供測試音訊及影像檔案

- [ ] 16. 實作 ESP32 韌體（C++/Arduino）
  - [x] 16.1 建立 ESP32 專案結構
    - 設定 Arduino IDE 或 PlatformIO
    - 引入必要的函式庫（WiFi、WebSocketsClient、ESP32-CAM、WiFiClientSecure）
    - _需求：1.1_
  
  - [x] 16.2 實作音訊採集及上傳
    - 配置 I2S 麥克風（16kHz, mono, PCM16）
    - 實作音訊緩衝區（100ms/chunk）
    - 實作 WebSocket 連線至 Cloudflare Tunnel（WSS）
    - 配置 SSL/TLS 連線（使用 WiFiClientSecure）
    - 實作音訊串流上傳至 `/ws_audio`
    - _需求：1.1_
  
  - [x] 16.3 實作拍照功能
    - 連接至 `/ws_ctrl` 接收 CAPTURE 指令（透過 WSS）
    - 實作相機初始化（640x480 JPEG）
    - 實作拍照及 JPEG 編碼
    - 連接至 `/ws_camera` 上傳影像（透過 WSS）
    - 實作 req_id 關聯（JSON 標頭 + 二進位資料）
    - _需求：3.2, 3.3, 3.5_
  
  - [x] 16.4 實作斷線重連
    - 實作 WiFi 斷線檢測
    - 實作 WebSocket 斷線檢測
    - 實作 3 秒重連邏輯（指數退避）
    - 處理 SSL/TLS 重連
    - _需求：6.1_
  
  - [ ]* 16.5 撰寫 ESP32 韌體文件
    - 說明硬體接線
    - 說明配置步驟（WiFi SSID/密碼、Cloudflare Tunnel 網址）
    - 說明 SSL/TLS 憑證處理（Cloudflare 根憑證）
    - 說明燒錄步驟

- [x] 17. 檢查點 - 確保端到端流程測試通過
  - 確保所有測試通過，如有問題請詢問使用者。

- [ ] 18. 整合測試及除錯
  - [ ]* 18.1 執行完整流程整合測試
    - 使用 ESP32 模擬器發送音訊
    - 驗證 ASR 轉錄
    - 驗證觸發檢測
    - 驗證拍照指令及影像上傳
    - 驗證視覺模型呼叫
    - 驗證 Web UI 顯示
    - _需求：所有需求_
  
  - [ ]* 18.2 執行斷線恢復測試
    - 模擬 ESP32 斷線
    - 模擬 ASR 服務斷線
    - 模擬 Web UI 斷線
    - 驗證自動重連及狀態恢復
    - _需求：6.1, 6.2, 6.3, 6.4_
  
  - [ ]* 18.3 執行錯誤處理測試
    - 觸發各種錯誤情況
    - 驗證錯誤記錄
    - 驗證錯誤恢復
    - _需求：所有需求的錯誤處理_

- [ ] 19. 文件及部署準備
  - [x] 19.1 撰寫 README.md
    - 專案概述
    - 系統架構圖
    - 安裝步驟（包含 Cloudflare Tunnel 設定）
    - 配置說明
    - 執行指令
    - 本機開發工作流程
  
  - [x] 19.2 撰寫 API 文件
    - WebSocket 端點說明
    - HTTP API 端點說明
    - 事件格式說明
    - 錯誤碼說明
  
  - [x] 19.3 建立 requirements.txt 及 setup.py
    - 列出所有 Python 依賴
    - 指定版本號
  
  - [x] 19.4 設定 Cloudflare Tunnel
    - 安裝 cloudflared
    - 建立 Tunnel 及配置檔
    - 設定 DNS 記錄
    - 撰寫 Tunnel 啟動腳本
    - _需求：6.1, 7.1（安全連線）_
  
  - [ ]* 19.5 建立 Docker Compose 配置（可選）
    - 建立 Dockerfile（後端）
    - 建立 docker-compose.yml（包含 cloudflared 服務）
    - 建立 .env.example 範本

- [x] 20. 最終檢查點 - MVP 驗證
  - 驗證 MVP 成功定義：
    1. 使用者說出觸發指令 → 系統拍攝快照 → 視覺模型返回識別結果（10 秒內完成）
    2. 斷線後自動重連並恢復至 LISTENING 狀態
    3. Web UI 即時顯示所有事件
    4. API 金鑰僅存放於 VPS 後端
  - 如有問題請詢問使用者。

## 注意事項

- 標記 `*` 的任務為可選任務，可跳過以加快 MVP 開發
- 每個任務都參考特定需求以確保可追溯性
- 檢查點確保增量驗證
- 屬性測試驗證通用正確性屬性（最少 100 次迭代）
- 單元測試驗證特定範例及邊界條件
- ESP32 模擬器允許在沒有實體硬體的情況下進行測試
